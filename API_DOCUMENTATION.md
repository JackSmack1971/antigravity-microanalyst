# Microanalyst API Documentation

This document describes the primary programmatic entry points and integrations for the Antigravity Microanalyst system.

---

## REST API Endpoints

The Antigravity Microanalyst system exposes a FastAPI-based REST API for real-time market intelligence access.

**Base URL**: `http://localhost:8000` (development)  
**API Version**: v0.4.0  
**Authentication**: None (currently open for development)

### 1. Health Check

**Endpoint**: `GET /health`

**Description**: Returns the operational status of the API server.

**Response Schema** (`HealthResponse`):
```json
{
  "status": "string",
  "service": "string"
}
```

**Example Request**:
```bash
curl http://localhost:8000/health
```

**Example Response**:
```json
{
  "status": "online",
  "service": "Antigravity Swarm API"
}
```

**Status Codes**:
- `200 OK`: Server is operational

---

### 2. Get Latest Thesis

**Endpoint**: `GET /api/v1/latest/thesis`

**Description**: Retrieves the most recent market thesis generated by the adversarial agent swarm. Returns the synthesized decision, confidence score, reasoning, and multi-perspective analysis.

**Response Schema** (`ThesisResponse`):
```json
{
  "decision": "BUY | SELL | HOLD",
  "confidence": 0.85,
  "allocation_pct": 50.0,
  "reasoning": "Summary of the decision rationale",
  "bull_case": "Retail/bullish perspective (optional)",
  "bear_case": "Whale/bearish perspective (optional)",
  "macro_thesis": "Macro economist perspective (optional)",
  "logs": ["System log entry 1", "System log entry 2"]
}
```

**Field Descriptions**:
- `decision`: Trading action recommendation (BUY, SELL, or HOLD)
- `confidence`: Confidence score from 0.0 to 1.0
- `allocation_pct`: Recommended percentage of portfolio to allocate
- `reasoning`: Synthesized reasoning from the facilitator agent
- `bull_case`: Retail momentum analyst's bullish perspective
- `bear_case`: Whale sniper analyst's bearish/cautious perspective  
- `macro_thesis`: Macro economist's structural correlation analysis
- `logs`: Array of system logs documenting the agent debate process

**Example Request**:
```bash
curl http://localhost:8000/api/v1/latest/thesis
```

**Example Response** (Thesis Available):
```json
{
  "decision": "BUY",
  "confidence": 0.85,
  "allocation_pct": 50.0,
  "reasoning": "BTC decoupling from DXY/SPY into a structural Safe Haven. | Mixed signals. | Macro Economist logic validated.",
  "bull_case": "[RETAIL]: Market momentum is accelerating with high funding rates...",
  "bear_case": "[WHALE]: Wait for liquidity. Intent: Accumulate at lower levels...",
  "macro_thesis": "[MACRO]: Bitcoin showing neutral-to-positive DXY correlation...",
  "logs": [
    "System initialized with BALANCED thinking (Vol: 40)",
    "Initiating high-concurrency cognitive debate...",
    "Institutional Agent calculated variances.",
    "Facilitator sided with Macro Economist."
  ]
}
```

**Example Response** (Waiting for Swarm):
```json
{
  "status": "waiting_for_swarm",
  "thesis": null
}
```

**Status Codes**:
- `200 OK`: Thesis retrieved successfully or waiting status returned
- `500 Internal Server Error`: File read error

---

### 3. Stream Logs (Server-Sent Events)

**Endpoint**: `GET /api/v1/stream/logs`

**Description**: Establishes a Server-Sent Events (SSE) connection to stream real-time log updates from the data retrieval pipeline.

**Protocol**: SSE (Server-Sent Events)

**Event Format**:
```
event: log
data: <log line content>
```

**Example Request**:
```bash
curl -N http://localhost:8000/api/v1/stream/logs
```

**Example Stream Output**:
```
event: log
data: [2025-12-21 19:00:00] Starting async retrieval pipeline

event: log
data: [2025-12-21 19:00:01] Fetching CoinGlass order flow data...

event: log
data: [2025-12-21 19:00:03] âœ“ Successfully retrieved funding rates
```

**Client-Side Usage** (JavaScript):
```javascript
const eventSource = new EventSource('http://localhost:8000/api/v1/stream/logs');
eventSource.addEventListener('log', (event) => {
  console.log('Log:', event.data);
});
```

**Status Codes**:
- `200 OK`: Stream established successfully

**Notes**:
- Connection remains open until client disconnects
- Tails the log file from the end (only new entries are streamed)
- Polls every 500ms for new log lines

---

## Python Module APIs

## 1. Data Retrieval Pipeline

### Live Retrieval
**Module**: `src/microanalyst/live_retrieval.py`

Fetches data from all configured sources using the discovery engine.

- **Usage**:
  ```bash
  python src/microanalyst/live_retrieval.py
  ```
- **Outputs**:
  - Raw artifacts in `data_exports/`
  - Normalization ready datasets.

## 2. Agent Intelligence Swarm

### Agent Coordinator
**Module**: `src/microanalyst/agents/agent_coordinator.py`

Orchestrates specialized analyst roles into a synthesized market thesis.

- **Available Roles**:
  - `DATA_COLLECTOR`: Fetches raw data.
  - `ANALYST_TECHNICAL`: Performs statistical price analysis.
  - `ANALYST_SENTIMENT`: Aggregates cross-platform social sentiment.
  - `ANALYST_RISK`: Evaluates volatility and drawdown risks.
  - `PREDICTION_ORACLE`: Forecasts T+24h direction.
  - `SYNTHESIZER`: Combines all inputs into the final thesis.

## 3. Knowledge & ML Lifecycle

### Automated Retrainer
**Module**: `src/microanalyst/intelligence/automated_retrainer.py`

Handles the continuous training and evaluation of the Oracle models.

- **Workflow**:
  1. Detect frequency from data.
  2. Build labeled ML dataset.
  3. Train candidate model.
  4. Compare with active model.
  5. Promote if improvement > 2%.

## 4. WebSocket API (Experimental)

### Subscription Topics
The system supports real-time updates via WebSocket (see `src/microanalyst/mcp_server.py`).

- `market_data`: Raw OHLCV updates.
- `agent_thesis`: Live outputs from the Synthesizer agent.
- `oracle_signal`: T+24h price target forecasts.

## 5. Visualization & Reporting (V6)

### Swarm Command Visualizer
**Module**: `src/microanalyst/reporting/visualizer_app.py`

Streamlit-based interface for synthesizing swarm intelligence and ML forecasts.

- **Usage**:
  ```bash
  streamlit run src/microanalyst/reporting/visualizer_app.py
  ```
- **Features**:
  - `render_header`: Renders the neon metric grid.
  - `render_swarm_debate`: Displays the adversarial persona stack.
  - `render_logs`: Real-time system status and logs.
